"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var __assign=function(){return(__assign=Object.assign||function(e){for(var t,i=1,n=arguments.length;i<n;i++)for(var r in t=arguments[i])Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e}).apply(this,arguments)},Get=function(e,t){if(t)return(t=t.split(".")).reduce(function(e,t){return e&&e[t]?e[t]:null},e)};function Set(i,e,n){if(e){var r=e.split(".");return r.forEach(function(e,t){t===r.length-1&&(i[e]=n),null==i[e]&&(isNaN(r[t+1])?i[e]={}:i[e]=[]),i=i[e]}),i}}var left="LEFT",right="RIGHT",up="UP",down="DOWN",enter="ENTER",KeyCodes={map:{LEFT:left,RIGHT:right,UP:up,DOWN:down,ENTER:enter},codes:{4:left,21:left,37:left,214:left,205:left,218:left,5:right,22:right,39:right,213:right,206:right,217:right,29460:up,19:up,38:up,211:up,203:up,215:up,29461:down,20:down,40:down,212:down,204:down,216:down,29443:enter,13:enter,67:enter,32:enter,23:enter,195:enter}},Closest=function(e,i){return e.reduce(function(e,t){return Math.abs(t-i)<Math.abs(e-i)?t:e})},endsWith=function(e,t){return-1!==e.indexOf(t,e.length-t.length)},arrayFind=function(e,t){for(var i=e.length,n=0;n<i;){if(t(e[n],n,e))return e[n];n++}},isNodeFocusable=function(e){return null!=e.isFocusable?e.isFocusable:!!e.selectAction},getDirectionForKeyCode=function(e){var t=KeyCodes.codes[e];return t?t.toUpperCase():null},isDirectionAndOrientationMatching=function(e,t){return!(!e||!t)&&(e=e.toUpperCase(),"*"===(t=t.toUpperCase())||"VERTICAL"===e&&("UP"===t||"DOWN"===t)||"HORIZONTAL"===e&&("LEFT"===t||"RIGHT"===t))},isNodeInPath=function(e,t){return 0===e.lastIndexOf(t.id+".",0)||(!!endsWith(e,"."+t.id)||-1!==e.indexOf("."+t.id+"."))},isNodeInPaths=function(e,t){return e.some(function(e){return isNodeInPath(e,t)})},_findChildWithMatchingIndexRange=function(i,n){if(!i.children)return null;var e=arrayFind(Object.keys(i.children),function(e){var t=i.children[e];return t.indexRange&&t.indexRange[0]<=n&&t.indexRange[1]>=n});return e?i.children[e]:void 0},_findChildWithIndex=function(t,i){if(!t.children)return null;var e=arrayFind(Object.keys(t.children),function(e){return t.children[e].index===i});return e?t.children[e]:null},_findChildWithClosestIndex=function(t,e,i){if(void 0===i&&(i=null),!t.children)return null;var n=t.children[t.activeChild];if(i&&n&&n.index>=i[0]&&n.index<=i[1]&&isNodeFocusable(n))return n;var r=Object.keys(t.children).filter(function(e){return isNodeFocusable(t.children[e])||t.children[e].children}).map(function(e){return t.children[e].index});return r.length<=0?null:_findChildWithIndex(t,Closest(r,e))},getNodesFromTree=function(e){var r=[],o=function(i,n){Object.keys(i).forEach(function(e){var t=i[e].parent||n;r.push(__assign(__assign({},i[e]),{id:e,children:void 0,parent:t})),i[e].children&&o(i[e].children,e)})};return o(e,void 0),r};function mitt(n){return n=n||Object.create(null),{on:function(e,t){(n[e]||(n[e]=[])).push(t)},off:function(e,t){n[e]&&n[e].splice(n[e].indexOf(t)>>>0,1)},emit:function(t,i){(n[t]||[]).slice().map(function(e){e(i)}),(n["*"]||[]).slice().map(function(e){e(t,i)})}}}var Lrud=function(){function e(){this.tree={},this.nodePathList=[],this.focusableNodePathList=[],this.rootNodeId=null,this.currentFocusNode=null,this.currentFocusNodeId=null,this.currentFocusNodeIndex=null,this.currentFocusNodeIndexRange=null,this.isIndexAlignMode=!1,this.emitter=mitt(),this.overrides={}}return e.prototype.reindexChildrenOfNode=function(i){if(i&&i.children){var e=Object.keys(i.children).map(function(e){return i.children[e]});return e.sort(function(e,t){return e.index-t.index}),i.children={},e.forEach(function(e,t){e.index=t,i.children[e.id]=e}),Set(this.tree,this.getPathForNodeId(i.id),i),i}},e.prototype.on=function(e,t){this.emitter.on(e,t)},e.prototype.getRootNode=function(){var e=this.getNode(this.rootNodeId);if(!e)throw new Error("no root node");return e},e.prototype.getPathForNodeId=function(t){return t===this.rootNodeId?this.rootNodeId:arrayFind(this.nodePathList,function(e){return endsWith(e,"."+t)})},e.prototype.registerNode=function(e,t){if(void 0===t&&(t={}),t.id||(t.id=e),this.getNode(e))throw Error("Node with an ID of "+e+" has already been registered");if(Object.keys(this.tree).length<=0)return this.rootNodeId=e,this.tree[e]=t,this.nodePathList.push(e),this;if(null==t.parent&&e!==this.rootNodeId&&(t.parent=this.rootNodeId),null==arrayFind(this.nodePathList,function(e){return-1<e.indexOf(t.parent+".children")})){var i=this.getPathForNodeId(t.parent);Set(this.tree,i+".activeChild",e)}if(!t.index&&this.getNode(t.parent)){var n=this.getNode(t.parent).children;t.index=n?Object.keys(n).length:0}var r=arrayFind(this.nodePathList,function(e){return endsWith(e,t.parent)})+".children."+e;return Set(this.tree,r,t),this.nodePathList.push(r),isNodeFocusable(t)&&this.focusableNodePathList.push(r),this},e.prototype.register=function(e,t){return void 0===t&&(t={}),this.registerNode(e,t)},e.prototype.unregister=function(e,t){this.unregisterNode(e,t)},e.prototype.unregisterNode=function(e,t){var i=this;if(void 0===t&&(t={forceRefocus:!0}),e===this.rootNodeId)return this.tree={},this.nodePathList=[],this.focusableNodePathList=[],this.rootNodeId=null,this.currentFocusNode=null,this.currentFocusNodeId=null,this.currentFocusNodeIndex=null,this.currentFocusNodeIndexRange=null,this.isIndexAlignMode=!1,this.emitter=mitt(),void(this.overrides={});var n=this.getPathForNodeId(e);if(n){var r=Get(this.tree,n),o=this.getNode(r.parent);return delete o.children[e],this.nodePathList.splice(this.nodePathList.indexOf(n),1),this.nodePathList=this.nodePathList.filter(function(e){return-1===e.indexOf(n+".children.")}),this.focusableNodePathList=this.focusableNodePathList.filter(function(e){return-1===e.indexOf(n+".children.")}),isNodeFocusable(r)&&this.focusableNodePathList.splice(this.focusableNodePathList.indexOf(n),1),o.activeChild&&o.activeChild===e&&(this.isIndexAlignMode=!1,delete o.activeChild,t.forceRefocus&&this.recalculateFocus(r)),this.reindexChildrenOfNode(o),Set(this.tree,this.getPathForNodeId(o.id),o),this.emitter.emit("blur",r),r.onBlur&&r.onBlur(r),Object.keys(this.overrides).forEach(function(e){var t=i.overrides[e];t.target!==r.id&&t.id!==r.id||i.unregisterOverride(e)}),this}},e.prototype.registerOverride=function(e,t){if(!e)throw new Error("need an ID to register an override");if(this.overrides[e])throw new Error("override with ID of "+e+" already exists");if(!t.id)throw new Error("registering override: "+e+" - missing internal id");if(!t.direction)throw new Error("registering override: "+e+" - missing internal direction");if(!t.target)throw new Error("registering override: "+e+" - missing internal target");return this.overrides[e]=t,this},e.prototype.unregisterOverride=function(e){return delete this.overrides[e],this},e.prototype.getNode=function(e){return Get(this.tree,this.getPathForNodeId(e))},e.prototype.pickNode=function(e){var t=this.getNode(e);if(t)return this.unregisterNode(e),t},e.prototype.climbUp=function(i,n){var r=this;if(!i)return null;var e=arrayFind(Object.keys(this.overrides),function(e){var t=r.overrides[e];return t.id===i.id&&t.direction.toUpperCase()===n.toUpperCase()});if(e)return this.getNode(this.overrides[e].target);if(isNodeFocusable(i))return this.climbUp(this.getNode(i.parent),n);if(!isNodeInPaths(this.focusableNodePathList,i))return this.climbUp(this.getNode(i.parent),n);if(!isDirectionAndOrientationMatching(i.orientation,n))return this.climbUp(this.getNode(i.parent),n);var t=this.getNextChildInDirection(i,n);if(!t)return i;var o=t&&t.id===i.activeChild,d=isNodeFocusable(this.getNode(i.activeChild)),s=isNodeInPaths(this.focusableNodePathList,i);return o&&(d||s)?this.climbUp(this.getNode(i.parent),n):i},e.prototype.digDown=function(e,t){if(void 0===t&&(t=null),isNodeFocusable(e))return e;if(this.isIndexAlignMode){if(e.isIndexAlign){var i=this.getNode(e.parent);if("vertical"===i.orientation){if("UP"===t)return this.digDown(_findChildWithClosestIndex(this.getNodeLastChild(e),this.currentFocusNodeIndex,this.currentFocusNodeIndexRange),t);if("DOWN"===t)return this.digDown(_findChildWithClosestIndex(this.getNodeFirstChild(e),this.currentFocusNodeIndex,this.currentFocusNodeIndexRange),t)}if("horizontal"===i.orientation){if("LEFT"===t){var n=_findChildWithClosestIndex(e,this.getNode(this.currentFocusNode.parent).index);return this.digDown(this.getNodeLastChild(n),t)}if("RIGHT"===t){n=_findChildWithClosestIndex(e,this.getNode(this.currentFocusNode.parent).index);return this.digDown(this.getNodeFirstChild(n),t)}}}var r=_findChildWithMatchingIndexRange(e,this.currentFocusNodeIndex);return r?this.digDown(r,t):this.digDown(_findChildWithClosestIndex(e,this.currentFocusNodeIndex,this.currentFocusNodeIndexRange),t)}if(!isNodeFocusable(e)&&!this.doesNodeHaveFocusableChildren(e)){var o=this.getNode(e.parent),d=this.getNextChildInDirection(__assign(__assign({},o),{activeChild:e.id}),t);return d.id===e.id?null:this.digDown(d,t)}e.activeChild||(e.activeChild=this.getNodeFirstChild(e).id);var s=e.children[e.activeChild];return isNodeFocusable(s)?s:this.digDown(s,t)},e.prototype.getNextChildInDirection=function(e,t){return void 0===t&&(t=null),t?(t=t.toUpperCase(),"horizontal"===e.orientation&&"RIGHT"===t?this.getNextChild(e):"horizontal"===e.orientation&&"LEFT"===t?this.getPrevChild(e):"vertical"===e.orientation&&"DOWN"===t?this.getNextChild(e):"vertical"===e.orientation&&"UP"===t?this.getPrevChild(e):null):this.getNextChild(e)},e.prototype.getNextChild=function(e){e.activeChild||(e.activeChild=this.getNodeFirstChild(e).id);var t=e.children[e.activeChild].index,i=_findChildWithIndex(e,t+1);return i=i||(e.isWrapping?this.getNodeFirstChild(e):e.children[e.activeChild])},e.prototype.getPrevChild=function(e){e.activeChild||(e.activeChild=this.getNodeFirstChild(e).id);var t=e.children[e.activeChild].index,i=_findChildWithIndex(e,t-1);return i=i||(e.isWrapping?this.getNodeLastChild(e):e.children[e.activeChild])},e.prototype.getNodeFirstChild=function(t){if(t.children){var e=Object.keys(t.children).map(function(e){return t.children[e].index}).sort(function(e,t){return e-t});return _findChildWithIndex(t,e[0])}},e.prototype.getNodeLastChild=function(t){if(t.children){var e=Object.keys(t.children).map(function(e){return t.children[e].index}).sort(function(e,t){return e-t});return _findChildWithIndex(t,e[e.length-1])}},e.prototype.handleKeyEvent=function(e){var t=e.keyCode?getDirectionForKeyCode(e.keyCode):e.direction.toUpperCase(),i=this.getNode(this.currentFocusNodeId);if("ENTER"===t)return this.emitter.emit("select",i),void(i.onSelect&&i.onSelect(i));var n=this.climbUp(i,t);if(n){this.isIndexAlignMode=!0===n.isIndexAlign;var r=this.getNextChildInDirection(n,t),o=r?this.digDown(r,t):this.digDown(n,t);if(o)return i.shouldCancelLeave&&i.shouldCancelLeave(i,o)?(i.onLeaveCancelled&&i.onLeaveCancelled(i,o),this.emitter.emit("cancelled",{leave:i,enter:o}),i):o.shouldCancelEnter&&o.shouldCancelEnter(i,o)?(o.onEnterCancelled&&o.onEnterCancelled(i,o),this.emitter.emit("cancelled",{leave:i,enter:o}),i):(this.assignFocus(o.id),this.emitter.emit("move",{leave:i,enter:o,direction:t,offset:"LEFT"===t||"UP"===t?-1:1}),n.onMove&&n.onMove({node:n,leave:i,enter:o,direction:t,offset:"LEFT"===t||"UP"===t?-1:1}),i.onLeave&&i.onLeave(i),o.onEnter&&o.onEnter(o),o)}},e.prototype.setActiveChild=function(e,t){var i=this.getNode(t),n=this.getNode(e);if(i&&n.activeChild&&n.activeChild!==i.id){var r=this.getNode(n.activeChild);n.activeChild=i.id,this.emitter.emit("inactive",r),r.onInactive&&r.onInactive(r),this.emitter.emit("active",i),i.onActive&&i.onActive(i),n.onActiveChildChange&&n.onActiveChildChange({node:n,leave:r,enter:i})}},e.prototype.setActiveChildRecursive=function(e,t){this.setActiveChild(e,t);var i=this.getNode(e);i.parent&&this.setActiveChildRecursive(i.parent,i.id)},e.prototype.assignFocus=function(e){var t=this.getNode(e);if(t.children&&!this.doesNodeHaveFocusableChildren(t))throw new Error('"'+t.id+'" does not have focusable children. Are you trying to assign focus to '+t.id+"?");if(isNodeFocusable(t)||(t=this.digDown(t)),!t)throw new Error("trying to assign focus to a non focusable node");if(this.currentFocusNodeId){var i=this.getNode(this.currentFocusNodeId);i&&(this.emitter.emit("blur",i),i.onBlur&&i.onBlur(i))}this.currentFocusNodeId=t.id,(this.currentFocusNode=t).indexRange?(this.currentFocusNodeIndex=t.indexRange[0],this.currentFocusNodeIndexRangeLowerBound=t.indexRange[0],this.currentFocusNodeIndexRangeUpperBound=t.indexRange[1],this.currentFocusNodeIndexRange=t.indexRange):(this.currentFocusNodeIndex=t.index,this.currentFocusNodeIndexRangeLowerBound=t.index,this.currentFocusNodeIndexRangeUpperBound=t.index),t.parent&&this.setActiveChildRecursive(t.parent,t.id),t.onFocus&&t.onFocus(t),this.emitter.emit("focus",t)},e.prototype.recalculateFocus=function(e){var t=this.getNode(e.parent),i=this.climbUp(t,"*");if(i){var n=this.getPrevChild(i);if(isNodeFocusable(n)||n&&n.children&&Object.keys(n.children).length){var r=this.digDown(n);this.assignFocus(r.id)}else this.assignFocus(i.id)}else this.currentFocusNode=void 0,this.currentFocusNodeId=void 0,this.currentFocusNodeIndex=void 0},e.prototype.registerTree=function(e){var t=this;getNodesFromTree(e).forEach(function(e){t.registerNode(e.id,e)})},e.prototype.insertTree=function(e,t){void 0===t&&(t={maintainIndex:!0});var i=e[Object.keys(e)[0]];i.id||(i.id=Object.keys(e)[0]);var n=this.pickNode(i.id);!i.parent&&n&&n.parent&&(i.parent=n.parent);var r=this.getNode(i.parent);t.maintainIndex&&n&&n.index&&(i.index=n.index,Object.keys(r.children).forEach(function(e){var t=r.children[e];t.index>=n.index&&(t.index+=1)})),this.registerTree(e),t.maintainIndex&&this.reindexChildrenOfNode(r)},e.prototype.doesNodeHaveFocusableChildren=function(t){return this.focusableNodePathList.some(function(e){return-1<e.indexOf(t.id+".")})},e.prototype.setNodeFocusable=function(e,t){var i=this.getNode(e);if(i&&isNodeFocusable(i)!==t)if(i.isFocusable=t){n=this.getPathForNodeId(e);this.focusableNodePathList.push(n)}else{var n=this.getPathForNodeId(e);this.focusableNodePathList.splice(this.focusableNodePathList.indexOf(n),1);var r=this.getNode(i.parent);if(r&&r.activeChild&&r.activeChild===e){delete r.activeChild;var o=this.getNextChild(r);o&&this.setActiveChild(r.id,o.id)}this.currentFocusNodeId===e&&this.recalculateFocus(i)}},e}();exports.Lrud=Lrud;
